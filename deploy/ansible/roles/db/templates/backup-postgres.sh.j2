#!/bin/bash
set -euo pipefail

BACKUP_DIR="${HOME}/backups/postgres"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/backup_${TIMESTAMP}.sql.gz"
RETENTION_DAYS=7

mkdir -p "${BACKUP_DIR}"

echo "[$(date)] Starting PostgreSQL backup..."

if ! systemctl --user is-active --quiet postgres.service; then
    echo "[$(date)] ERROR: PostgreSQL service is not running"
    exit 1
fi

if podman exec postgres pg_dump -U {{ postgres_user }} {{ postgres_db }} | gzip > "${BACKUP_FILE}"; then
    echo "[$(date)] Backup completed successfully: ${BACKUP_FILE}"
    
    find "${BACKUP_DIR}" -name "backup_*.sql.gz" -type f -mtime +${RETENTION_DAYS} -delete
    echo "[$(date)] Cleaned up backups older than ${RETENTION_DAYS} days"
    
    BACKUP_SIZE=$(du -h "${BACKUP_FILE}" | cut -f1)
    echo "[$(date)] Backup size: ${BACKUP_SIZE}"
else
    echo "[$(date)] ERROR: Backup failed"
    rm -f "${BACKUP_FILE}"
    exit 1
fi
