---
- name: Ensure baduk application directory exists
  become: true
  file:
    path: /opt/baduk
    state: directory
    owner: baduk
    group: baduk
    mode: '0755'

- name: Detect system architecture
  set_fact:
    baduk_arch: "{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}"

- name: Download and extract baduk release
  unarchive:
    src: "https://github.com/hazzardr/baduk-online/releases/latest/download/baduk-linux-{{ baduk_arch }}.tar.gz"
    dest: /opt/baduk
    remote_src: yes
    owner: baduk
    group: baduk
    mode: '0755'
  become: true
  notify:
    - restart baduk

- name: Deploy application environment file
  become: true
  template:
    src: baduk.env.j2
    dest: /opt/baduk/baduk.env
    owner: baduk
    group: baduk
    mode: '0600'
  notify:
    - restart baduk

- name: Run database migrations
  command:
    cmd: /opt/baduk/goose -dir /opt/baduk/migrations postgres "{{ postgres_connection_string }}" up
  become: true
  become_user: baduk
  register: migration_result
  changed_when: "'OK' in migration_result.stdout"
  failed_when: migration_result.rc != 0

- name: Display migration output
  debug:
    var: migration_result.stdout_lines

- name: Deploy baduk systemd service
  become: true
  template:
    src: baduk.service.j2
    dest: /etc/systemd/system/baduk.service
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload systemd daemon
    - restart baduk

- name: Enable and start baduk service
  become: true
  systemd:
    name: baduk
    enabled: yes
    state: started
    daemon_reload: yes
