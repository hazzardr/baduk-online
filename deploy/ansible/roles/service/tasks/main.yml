---
- name: Ensure systemd User Dir exists
  file:
    path: "~/.config/systemd/user"
    state: directory
    mode: '0755'
  
- name: Ensure user containers systemd directory exists
  file:
    path: "~/.config/containers/systemd"
    state: directory
    mode: '0700'

- name: Ensure baduk_env directory exists
  file:
    path: "~/baduk_env"
    state: directory
    mode: '0700'

- name: Deploy application environment file
  template:
    src: prod.yml.j2
    dest: "~/baduk_env/prod.yml"
    mode: '0600'
  notify:
    - restart baduk

- name: Login to GitHub Container Registry
  containers.podman.podman_login:
    username: "{{ vault_ghcr_username }}"
    password: "{{ vault_ghcr_token }}"
    registry: ghcr.io
  when: vault_ghcr_username is defined and vault_ghcr_token is defined

- name: Pull baduk-online image
  containers.podman.podman_image:
    name: ghcr.io/hazzardr/baduk-online:main
    force: true
  register: pull_result
  failed_when: pull_result.failed | default(false)

- name: Deploy service container
  template:
    src: baduk.container.j2
    dest: "~/.config/containers/systemd/baduk.container"
    mode: '0600'
  notify:
    - reload systemd user daemon
    - restart baduk

- name: Run database migrations
  containers.podman.podman_container:
    name: baduk-migrate
    image: ghcr.io/hazzardr/baduk-online:main
    state: started
    detach: false
    rm: true
    network: baduk.network
    env_file: "~/baduk_env/prod.yml"
    command: ["goose", "-dir", "/app/migrations", "postgres", "{{ postgres_connection_string }}", "up"]
  register: migration_result
  failed_when: migration_result.failed | default(false) or (migration_result.container is defined and migration_result.container.State.ExitCode != 0)

- name: Display migration output
  debug:
    var: migration_result.stdout_lines
  when: migration_result.stdout_lines is defined

