name: Build and Release

on:
  push:
    branches: [ "main" ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Set up Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6
        with:
          go-version: '^1.25'
      
      - name: Install goose
        run: go install github.com/pressly/goose/v3/cmd/goose@latest
      
      - name: Build binaries
        run: |
          # Build for amd64
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 GOEXPERIMENT=jsonv2 \
            go build -o dist/baduk-linux-amd64 .
          
          # Build for arm64
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 GOEXPERIMENT=jsonv2 \
            go build -o dist/baduk-linux-arm64 .
          
          # Copy goose binary
          cp $(go env GOPATH)/bin/goose dist/goose-linux-amd64
          
          # Build goose for arm64
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 \
            go build -o dist/goose-linux-arm64 github.com/pressly/goose/v3/cmd/goose
          
          # Make executable
          chmod +x dist/*
          
          # Show sizes
          ls -lh dist/
      
      - name: Create tarball with migrations
        run: |
          mkdir -p dist/release-amd64 dist/release-arm64
          
          # amd64 release
          cp dist/baduk-linux-amd64 dist/release-amd64/baduk
          cp dist/goose-linux-amd64 dist/release-amd64/goose
          cp -r migrations dist/release-amd64/
          tar -czf dist/baduk-linux-amd64.tar.gz -C dist/release-amd64 .
          
          # arm64 release
          cp dist/baduk-linux-arm64 dist/release-arm64/baduk
          cp dist/goose-linux-arm64 dist/release-arm64/goose
          cp -r migrations dist/release-arm64/
          tar -czf dist/baduk-linux-arm64.tar.gz -C dist/release-arm64 .
          
          # Show tarball sizes
          ls -lh dist/*.tar.gz
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: baduk-binaries
          path: dist/*.tar.gz
          retention-days: 30
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.tar.gz
          generate_release_notes: true
